<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <style>
        *{margin:0;padding:0}
        html,body{
            width:100%;
            height:100%;
        }
        #main{
            width:1280px;
            height:600px;
            margin: 20px auto;
            border:1px solid #ddd;
        }
    </style>
</head>
<body>
<div id="main">

</div>
<!--<script src="./js/jquery-ui.js" ></script>
<script src="./js/jquery.min.js"></script>-->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="js/echarts.min.js"></script>
<script src="js/china.js"></script>
<script src="js/CityPoint.js"></script>

<script>
    var myChart = echarts.init(document.getElementById('main'));
    var markPointData=[];//用于在地图上标注点
    var Cname=[];//用与存放城市名字
    var Clog=[];//用于存放城市longitude
    var Clat=[];//用于存放城市latitude
    var count=0;
    for(var i=0;i<cityCoord.length;i++){
        Cname.push(cityCoord[i].name);
        Clat.push(cityCoord[i].lat);
        Clog.push(cityCoord[i].log);

    }
    function CompareName(cityname) {
        var result=-1;
        for(var i=0;i<Cname.length;i++){
            if (Cname[i]==cityname)
            {
                result=i;break;
            }
        }
        return result;
    }
    function FromandWhen(departureCityName,departureTime) {
        $.ajax({
            type: "GET",
            url: "../flights/flyToWhere?departureCityName=" + departureCityName
                + "&departureTime=" + departureTime,
            contentType: "application/x-www-form-urlencoded;charset=UTF-8",
            dataType: "json",
            success: function (data) {
                //这里该做什么？
                //将数据中的城市名，价格提取
                // console.log(data);
                var DepartCityName=data[0].departure_cityname;
                var dt=data[0].departure_time.toString();
                var da = new Date(parseInt(dt.replace("/Date(","").replace(")/","").split("+")[0]));
                var year=da.getFullYear();
                var month=da.getMonth()+1;
                var day=da.getDate();
                if (month<10)
                    month="0"+month;
                if (day<10)
                    day="0"+day;
                var DepartDate=year+"-"+ month+"-" +day;
                console.log("日期====="+DepartDate);
                var cityName = [];//存放城市名字
                var price = [];//存放飞往城市的价格
                var index = 0;//用于指示所有城市中最低价格城市的索引
                for (var i = 0; i < data.length; i++) {
                    cityName.push(data[i].arrival_cityname);
                    price.push(data[i].price);
                    if (price[index] >= data[i].price) {
                        //比较最低价
                        index = i;
                    }
                }
                console.log(index);//显示最低价格城市索引
                /*   console.log(cityName);
                  console.log(price);*/
                //根据城市名，获取坐标，并将价格放入对应的点--markPointData
                for (var i = 0; i < cityName.length; i++) {
                    var flag = CompareName(cityName[i]);
                    // console.log(flag);
                    if (flag != -1) {
                        markPointData.push(
                            {
                                //城市名
                                "name": cityName[i],
                                //坐标
                                "coord": [Clog[flag], Clat[flag]],
                                //价格
                                "num": price[i],

                            }
                        )
                    } else {

                        console.log("数据:" + i + "定位失败" + data[i].arrival_cityname);

                    }
                }
                //存放出发城市
                {
                    var flag = CompareName(DepartCityName);
                    if (flag != -1) {
                        markPointData.push(
                            {
                                //城市名
                                "name": DepartCityName,
                                //坐标
                                "coord": [Clog[flag], Clat[flag]],
                                //价格
                                "num": 0,

                            }
                        )
                    } else {

                        console.log("出发城市======"+departureCityName+"======定位失败！\n");

                    }
                }

                // console.log("markPointData : " + markPointData);
                var option = {
                    backgroundColor: {//背景颜色
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 1,
                        y2: 1,
                        colorStops: [{
                            //背景渐变颜色，由于灰色感觉效果更好，所以没有渐变
                            offset: 0, color: 'grey' // 0% 处的颜色---最左边
                        }, {
                            offset: 1, color: 'grey' // 100% 处的颜色----最右边
                        }],
                        globalCoord: false // 缺省为 false
                    },
                    title: {
                        top: 20,
                        text: '去哪呀',
                        subtext: '',
                        x: 'center',
                        textStyle: {
                            color: 'black'
                        }
                    },
                    "tooltip": { //提示框组件。

                        "trigger": 'item', //触发类型 散点图

                        "enterable": true, //鼠标是否可进入提示框

                        "transitionDuration": 1, //提示框移动动画过渡时间

                        "formatter": function (params) {
                            //todo:返回省内低价航程城市的个数，此处返回省份名
                            return params.name //省级tooltip

                        },

                        "backgroundColor": '#fff',//应该是地图颜色

                        "borderWidth": '1px',

                        "borderRadius": '1',

                        "borderColor": 'rgba(255,150,128,1)',

                        "textStyle": {

                            "color": 'rgba(255,0,0,1)'

                        },

                        "padding": 20

                    },
                    "series": [{
                        "type": "map",
                        "mapType": "china",

                        "label": {

                            "normal": {

                                "show": true,

                            },

                            "emphasis": {

                                show: true,

                            }

                        },

                        "itemStyle": {

                            "normal": {

                                "backgroundColor": 'rgba(255,150,128,1)'

                            },

                            "emphasis": {

                                "backgroundColor": 'rgba(255,150,128,1)'

                            }

                        },
                        //此处可加载地图数据，地图或省份级别数据
                        /*   data:
                           ,*/
                        "zoom": 1.2, //当前视角的缩放比例。
                        roam: true, //是否开启平游或缩放
                        scaleLimit: { //滚轮缩放的极限控制

                            min: 1,

                            max: 20

                        },
                        "selectedMode": false,
                        "layoutCenter": ['50%', '53%'],
                        "layoutSize": "102%",
                        "label": { //图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等

                            "normal": {
                                //关闭显示省份文本标签，选中时，才显示
                                "show": false,

                                "textStyle": {

                                    "color": "#000", //正常状态的样式

                                    "fontSize": "12"

                                }

                            },

                            "emphasis": {

                                "show": true,

                                "textStyle": {

                                    "color": "#ff3631", //被选中的样式

                                    "fontSize": "12"

                                }

                            }

                        },
                        "markPoint":
                            { //图表标注。
                                //标注样式
                                //星型
                                // "symbol": 'path://M512 39.384615l169.353846 295.384615 342.646154 63.015385-240.246154 248.123077L827.076923 984.615385l-315.076923-145.723077L196.923077 984.615385l43.323077-334.769231L0 401.723077l342.646154-63.015385L512 39.384615',
                                //点型
                                // type: 'scatter',
                                type: function () {
                                    for (var i=0;i<markPointData.length;i++){
                                        if(markPointData[i]==DepartCityName){
                                            console.log("出发城市可定位");
                                            return 'path://M512 39.384615l169.353846 295.384615 342.646154 63.015385-240.246154 248.123077L827.076923 984.615385l-315.076923-145.723077L196.923077 984.615385l43.323077-334.769231L0 401.723077l342.646154-63.015385L512 39.384615';

                                        }
                                        else if(i==index){
                                            console.log(markPointData[i]);
                                        }
                                        else
                                            return 'scatter';
                                    }
                                },
                                "symbolSize": 80, //图形大小
                                // "symbolSize": 14, //图形大小
                                //标注内容设置
                                "label": {

                                    "normal": {
                                        "formatter": function (params) {
                                            var price;
                                            var str = "";
                                            if (params.name==DepartCityName){
                                               str=str+"城市："+DepartCityName+"\n这是您所在的城市";
                                            }
                                            else{
                                                for (var i = 0; i < markPointData.length; i++) {
                                                    if (markPointData[i].name == params.name) {
                                                        price = markPointData[i].num;
                                                        str += "城市：" + markPointData[i].name + "\n价格：" + price;
                                                    }

                                                }
                                            }
                                            return str;
                                        },
                                        position: 'inside',
                                        "show": true,
                                        color: "red"

                                    },

                                    "emphasis": {

                                        show: true,


                                    }

                                },
                                //
                                tooltip: { //标注点tooltip

                                    "formatter": function () {
                                        var str = " \n点击图标查看详细信息";
                                        return str;
                                    }
                                },

                                "itemStyle": {

                                    "normal": {

                                        "color": '#1dd8a3'
                                      /*  color:function (markPointData,index) {
                                            for(var i=0;i<markPointData.length;i++){
                                                if(i==index)
                                                    return '#14bed8'
                                                else
                                                    return '#1dd8a3';
                                            }
                                        }*/

                                    },
                                    emphasis:{
                                        "color": '#57d835'
                                    }


                                },
                                "data": markPointData

                            }
                    }]
                }
                myChart.setOption(option);
                //鼠标点击函数
                //todo:如果要实现点击搜索，在这里进行
                myChart.on('click', function (params) {
                    var arrivalCiyName=params.name;
                    var str="../Tazkarty/search.html?&type=2&dd="+encodeURI(DepartDate)
                        +"&dc="+encodeURI(DepartCityName)
                        +"&ac="+encodeURI(arrivalCiyName);
                    window.location.href=str;
                    window.event.returnValue=false;
                            //要获取某参数 eg:出发城市——data[i].departure_cityname



                });
            },
            error: function () {
                alert("传参失败，我也想知道为什么阿！！！");
            }
        })
    }

    //这里是用来传参的

    // FromandWhen("北京","2020-07-05");

    //这里是接受来自其他html文件的参数  departureCityName,   departureTime
    //url eg: http://localhost:8080/html/EchartsMap.html?departureCityName=北京&departureTime=2020-07-05
    var str=window.location.href;//取地址参数部分
    var url = str.split("?")[1];
    var departureCityName = url.split("departureCityName=")[1].split("&")[0];
    var departureTime = url.split("departureTime=")[1].split("&")[0];
    FromandWhen(departureCityName,departureTime);

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <style>
        *{margin:0;padding:0}
        html,body{
            width:100%;
            height:100%;
        }
        #main{
            width:1280px;
            height:600px;
            margin: 20px auto;
            border:1px solid #ddd;
        }
    </style>
</head>
<body>
<div id="main">

</div>
<!--<script src="./js/jquery-ui.js" ></script>
<script src="./js/jquery.min.js"></script>-->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="js/echarts.min.js"></script>
<script src="js/china.js"></script>
<script src="js/CityPoint.js"></script>

<script>
    var myChart = echarts.init(document.getElementById('main'));
    var markPointData=[];//用于在地图上标注点
    var Cname=[];//用与存放城市名字
    var Clog=[];//用于存放城市longitude
    var Clat=[];//用于存放城市latitude
    var count=0;
    for(var i=0;i<cityCoord.length;i++){
        Cname.push(cityCoord[i].name);
        Clat.push(cityCoord[i].lat);
        Clog.push(cityCoord[i].log);

    }
    function CompareName(cityname) {
        var result=-1;
        for(var i=0;i<Cname.length;i++){
            if (Cname[i]==cityname)
            {
                result=i;break;
            }
        }
        return result;
    }
    function FromandWhen(departureCityName,departureTime) {
        $.ajax({
            type:"GET",
            url:"../flights/flyToWhere?departureCityName="	+departureCityName
                +"&departureTime="	+ 	departureTime,
            contentType:"application/x-www-form-urlencoded;charset=UTF-8",
            dataType:"json",
            success:function (data) {
                //这里该做什么？
                //将数据中的城市名，价格提取
                console.log(data);
                var cityName=[];//存放城市名字
                var price=[];//存放飞往城市的价格
                var index=0;//用于指示所有城市中最低价格城市的索引
                for(var i=0;i<data.length;i++){
                    cityName.push(data[i].arrival_cityname);
                    price.push(data[i].price);
                    if(price[index]>=data[i].price){
                        //比较最低价
                        index=i;
                    }
                }
                /*   console.log(index);
                   console.log(cityName);
                   console.log(price);*/
                //根据城市名，获取坐标，并将价格放入对应的点--markPointData
                for (var i=0;i<cityName.length;i++){
                    var flag=CompareName(cityName[i]);
                    console.log(flag);
                    if (flag!=-1)
                    {
                        markPointData.push(
                            {
                                //城市名
                                "name":cityName[i],
                                //坐标
                                "coord":[Clog[flag],Clat[flag]],
                                //价格
                                "num":price[i],

                            }
                        )
                    }
                    else{

                        console.log("数据:"+i+"定位失败"+data[i]);

                    }
                }
                console.log("markPointData : "+markPointData);
                var option={
                    backgroundColor: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 1,
                        y2: 1,
                        colorStops: [{
                            //背景渐变颜色，由于灰色感觉效果更好，所以没有渐变
                            offset: 0, color: 'grey' // 0% 处的颜色
                        }, {
                            offset: 1, color: 'grey' // 100% 处的颜色
                        }],
                        globalCoord: false // 缺省为 false
                    },
                    title: {
                        top:20,
                        text: '去哪呀',
                        subtext: '',
                        x: 'center',
                        textStyle: {
                            color: 'black'
                        }
                    },
                    "tooltip": { //提示框组件。

                        "trigger": 'item', //触发类型 散点图

                        "enterable": true, //鼠标是否可进入提示框

                        "transitionDuration": 1, //提示框移动动画过渡时间

                        "formatter": function(params) {
                            //todo:返回省内低价航程城市的个数，此处返回省份名

                            return params.name //省级tooltip

                        },

                        "backgroundColor": '#fff',

                        "borderWidth": '1px',

                        "borderRadius": '1',

                        "borderColor": 'rgba(255,150,128,1)',

                        "textStyle": {

                            "color": 'rgba(255,0,0,1)'

                        },

                        "padding": 20

                    },
                    "series":[{
                        "type":"map",
                        "mapType":"china",

                        "label": {

                            "normal": {

                                "show": true,

                            },

                            "emphasis": {

                                show: true,

                            }

                        },

                        "itemStyle": {

                            "normal": {

                                "backgroundColor": 'rgba(255,150,128,1)'

                            },

                            "emphasis": {

                                "backgroundColor": 'rgba(255,150,128,1)'

                            }

                        },
                        //此处可加载地图数据，地图或省份级别数据
                        /*   data:
                           ,*/
                        "zoom": 1.2, //当前视角的缩放比例。
                        roam: true, //是否开启平游或缩放
                        scaleLimit: { //滚轮缩放的极限控制

                            min: 1,

                            max: 10

                        },
                        "selectedMode": false,
                        "layoutCenter": ['50%', '53%'],
                        "layoutSize": "102%",
                        "label": { //图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等

                            "normal": {

                                "show": true,

                                "textStyle": {

                                    "color": "#000", //正常状态的样式

                                    "fontSize": "12"

                                }

                            },

                            "emphasis": {

                                "show": true,

                                "textStyle": {

                                    "color": "#f00", //被选中的样式

                                    "fontSize": "12"

                                }

                            }

                        },
                        "markPoint": { //图表标注。

                            "symbol": 'path://M512 39.384615l169.353846 295.384615 342.646154 63.015385-240.246154 248.123077L827.076923 984.615385l-315.076923-145.723077L196.923077 984.615385l43.323077-334.769231L0 401.723077l342.646154-63.015385L512 39.384615',

                            "symbolSize": 14, //图形大小

                            "label": {

                                "normal": {

                                    "show": true,

                                },

                                "emphasis": {

                                    show: true,

                                }

                            },

                            tooltip: { //标注点tooltip

                                "formatter": function(params) {
                                    //todo:修改函数,返回城市名和价格,待检测
                                    var price;
                                    var str="";
                                    for (var i=0;i<markPointData.length;i++){
                                        if(markPointData[i].name==params.name)
                                        { price=markPointData[i].num;
                                            if (i==index){
                                                str="走，咱们去这座城市，它最便宜\n城市："+params.name+" 价格："+price;
                                            }else{
                                                str="城市："+params.name+" 价格："+price;
                                            }
                                        }
                                    }
                                    str+=" \n点击图标查看详细信息";
                                    return str;
                                }

                            },

                            "itemStyle": {

                                "normal": {

                                    "color": 'red'

                                }

                            },
                            "data": markPointData

                        }
                    }]
                }
                myChart.setOption(option);
                //鼠标点击函数
                //todo:如果要实现点击搜索，在这里进行
                myChart.on('click', function (params) {
                    var str="";
                    for (var i=0;i<data.length;i++) {
                        if(data.arrival_cityname=params.name){
                            str+="出发城市："+data.departure_cityname
                                +"\n 到达城市："+data.arrival_cityname
                                +"\n 出发机场："+data.departure_airportname
                                +"\n 到达机场："+data.arrival_airpotname;
                        }
                    }
                    return str;
                });
            },
            error:function () {
                alert("传参失败，我也想知道为什么阿！！！");
            }
        })
    }
    //这里是用来传参的
    FromandWhen("北京","2020-07-05 21:50:00");
</script>
</body>
</html>
